<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Supervisor - Plataforma de Automação</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container auth-container">
        <h1>Registrar Nova Conta de Supervisor</h1>
        <p>Preencha os campos abaixo para criar uma nova conta de supervisor.</p>
        <p class="info-text"><b>Importante:</b> Para conectar-se automaticamente, utilize o <strong>mesmo e-mail e senha</strong> que você usa para acessar o programa Mais Médicos no site da UNA-SUS.</p>

        <form id="register-supervisor-form">
            <div class="form-group">
                <label for="register-email">E-mail do Supervisor:</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Senha:</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmar Senha:</label>
                <input type="password" id="confirm-password" required>
            </div>
            <div id="error-message" class="error-text hidden"></div>
            <div id="success-message" class="success-text hidden"></div>
            <button type="submit">Registrar Supervisor</button>
        </form>
        <p><a href="index.html">Voltar para o início</a></p>
    </div>

    <script type="module">
        import { app } from './firebase-config.js';
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        const functions = getFunctions(app);
        const registerSupervisorForm = document.getElementById('register-supervisor-form');
        const errorMessageDiv = document.getElementById('error-message');
        const successMessageDiv = document.getElementById('success-message');

        registerSupervisorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            errorMessageDiv.classList.add('hidden');
            successMessageDiv.classList.add('hidden');

            if (password !== confirmPassword) {
                errorMessageDiv.textContent = 'As senhas não coincidem.';
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            try {
                const createSupervisor = httpsCallable(functions, 'createSupervisor');
                const result = await createSupervisor({ email, password });

                if (result.data.success) {
                    successMessageDiv.textContent = 'Supervisor registrado com sucesso!';
                    successMessageDiv.classList.remove('hidden');
                    registerSupervisorForm.reset();
                } else {
                    errorMessageDiv.textContent = result.data.error || 'Ocorreu um erro ao registrar.';
                    errorMessageDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro detalhado ao chamar a função:", error);

                // Constrói uma mensagem de erro mais informativa
                let friendlyMessage = `Erro de comunicação: ${error.message}`;
                if (error.details) {
                    friendlyMessage = `${error.message} (Código: ${error.details.originalCode || 'desconhecido'})`;
                }

                errorMessageDiv.textContent = friendlyMessage;
                errorMessageDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>