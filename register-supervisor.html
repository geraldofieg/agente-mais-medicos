<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Supervisor - Plataforma de Automação</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container auth-container">
        <h1>Crie sua Conta de Supervisor</h1>
        <p>
            Utilize o <strong>mesmo e-mail e senha</strong> que você usa para acessar o portal da UNA-SUS.
            Ao se registrar, o sistema irá conectar-se automaticamente ao portal para importar seus supervisionados.
        </p>

        <form id="register-supervisor-form">
            <div class="form-group">
                <label for="register-email">E-mail do Supervisor:</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Senha:</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmar Senha:</label>
                <input type="password" id="confirm-password" required>
            </div>
            <div id="error-message" class="error-text hidden"></div>
            <div id="success-message" class="success-text hidden"></div>
            <button type="submit">Registrar Supervisor</button>
        </form>
        <p><a href="index.html">Voltar para o início</a></p>
    </div>

    <script type="module">
        import { app } from './firebase-config.js';
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        const functions = getFunctions(app);
        const registerSupervisorForm = document.getElementById('register-supervisor-form');
        const errorMessageDiv = document.getElementById('error-message');
        const successMessageDiv = document.getElementById('success-message');

        registerSupervisorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            errorMessageDiv.classList.add('hidden');
            successMessageDiv.classList.add('hidden');

            if (password !== confirmPassword) {
                errorMessageDiv.textContent = 'As senhas não coincidem.';
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            try {
                const createSupervisor = httpsCallable(functions, 'createSupervisor');
                const result = await createSupervisor({ email, password });

                // A função agora retorna um status detalhado.
                if (result.data.success) {
                    registerSupervisorForm.reset();

                    // Verifica o status da importação dos médicos
                    if (result.data.importStatus === 'success') {
                        successMessageDiv.textContent = result.data.message;
                        successMessageDiv.classList.remove('hidden');
                    } else {
                        // A conta foi criada, mas a importação falhou. Mostra como um aviso.
                        // Usaremos o campo de erro para exibir esta mensagem de "sucesso parcial".
                        errorMessageDiv.innerHTML = `${result.data.message}<br>Detalhe: ${result.data.errorDetails || 'Não foi possível obter detalhes do erro.'}`;
                        errorMessageDiv.classList.remove('hidden');
                    }
                } else {
                    // Este bloco pode não ser alcançado se a função sempre lançar um erro em caso de falha.
                    errorMessageDiv.textContent = result.data.error || 'Ocorreu um erro desconhecido.';
                    errorMessageDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro detalhado ao chamar a função:", error);

                // Constrói uma mensagem de erro mais informativa
                let friendlyMessage = `Erro de comunicação: ${error.message}`;
                if (error.details) {
                    friendlyMessage = `${error.message} (Código: ${error.details.originalCode || 'desconhecido'})`;
                }

                errorMessageDiv.textContent = friendlyMessage;
                errorMessageDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
